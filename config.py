import os
from dotenv import load_dotenv

# Загружаем переменные окружения из .env файла
load_dotenv()

# RetailCRM API
RETAIL_CRM_BOT_TOKEN = os.getenv("RETAIL_CRM_BOT_TOKEN")
RETAILCRM_API_URL = os.getenv("RETAILCRM_API_URL")
RETAILCRM_BASE_URL = os.getenv("RETAILCRM_BASE_URL")
RETAILCRM_API_KEY = os.getenv("RETAILCRM_API_KEY")

# OpenAI API Key
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# Настройки Telegram и Google Forms
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
TELEGRAM_TOPIC_ID = os.getenv("TELEGRAM_TOPIC_ID")
TELEGRAM_WARNINGS_TOPIC_ID = os.getenv("TELEGRAM_WARNINGS_TOPIC_ID")
GOOGLE_FORMS_URL = os.getenv("GOOGLE_FORMS_URL")

# Список разрешенных доменов для платежных ссылок
# Добавьте сюда домены всех платежных систем, которые используют менеджеры.
ALLOWED_PAYMENT_DOMAINS = [
    'pay.alfabank.ru',
    'tropichouse.ru'
]

# Статичные категории для анализа (можно оставить в коде)
CATEGORIES = ['Заказ', 'Консультация', 'Технический', 'Доставка', 'Неизвестно']

# Остальные настройки
MG_URL = RETAILCRM_API_URL


# Адаптированный PROMPT_TEMPLATE для анализа чатов
PROMPT_TEMPLATE = """Ты эксперт по продажам, анализирующий текстовые диалоги в чатах. Твоя задача — внимательно проанализировать **только предоставленную переписку** между Менеджером и Клиентом и выставить ТОЧНУЮ оценку по каждому из 12 критериев из чек-листа ОКК. **Строго запрещено** делать предположения о действиях, которых нет в тексте. Если менеджер не задал какой-то вопрос или не совершил действие, **строго ставь 0 или -1 в JSON-оценках и пропускай этот пункт в SUMMARY.**

**Категоризация диалога:**
Определи категорию данного диалога из следующего списка: {}.
В JSON-ответе добавь новое поле "chat_category" со значением из этого списка.
Если "chat_category" равно "Технический" или "Доставка" или "Неизвестно", то все остальные критерии ("установление_контакта", "квалификация" и т.д.) должны быть равны 0 (не применимо).

**Интерпретация оценок (СТРОГО используй только эти значения):**
* **1 (выполнено):** Критерий выполнен полностью, эффективно и согласно всем требованиям.
* **0 (не применимо):** Критерий не применим к данному конкретному диалогу, так как не было соответствующей ситуации или возможности для его выполнения.
* **-1 (не выполнено):** Критерий был необходим, но менеджер его не выполнил, выполнил плохо, проигнорировал или допустил ошибку.

**Критерии для анализа (с детальной логикой оценки):**

1.  **Установление контакта:**
    * **1 (Выполнено):** Менеджер активно стремится установить контакт, используя как минимум ДВА из следующих пунктов: 1) Доброжелательное приветствие, 2) Называет клиента по имени (если это уместно), 3) Комплименты, 4) Подтверждение правильности выбора (например, "Рады вас видеть!", "Вы сделали правильный выбор!").
    * **0 (Не применимо):** Короткий диалог или контекст не предполагал такого взаимодействия.
    * **-1 (Не выполнено):** Менеджер сразу переходит к делу без приветствия, не представляется, или приветствие было сухим/формальным, не используя никаких пунктов для установления контакта.

2.  **Квалификация (что нужно, когда, сроки, бюджет):**
    * **1 (Выполнено):** Менеджер задал ВСЕ ТРИ ключевых вопроса на квалификацию:  1) Что именно интересует?, 2) К какой дате подбираете? 3) Есть ли рамки по бюджету?, чтобы собрать исчерпывающую информацию для предложения наилучшего решения.
    * **-1 (Не выполнено):** Менеджер задал менее трех вопросов на квалификацию, вопросы неточные, неполные, или сразу перешел к предложению без достаточного понимания ситуации клиента.

3.  **Выявление потребностей — какую проблему решает клиент:**
    * **1 (Выполнено):** Менеджер задал БОЛЕЕ ТРЕХ вопросов из списка для глубокого выявления потребностей и мотиваций клиента. Список вопросов: 1) Какой размер смотрите?, 2) Куда выбираете?, 3) Что для вас важно при выборе растения? (Цена, сроки, другие параметры....), 4) Почему именно "такой вариант" хотите?, 5) Первый раз покупаете растение?,  6) Уже знаете как правильно ухаживать за растением?, 7) Вам нужно менее прихотливое растение или это не важно?.
    * **-1 (Не выполнено):** Менеджер задал менее трех вопросов на выявление, или не пытался понять глубинные потребности клиента, ориентировался только на поверхностный запрос, игнорировал сигналы клиента о проблемах.

4.  **Презентация товара:**
    * **1 (Выполнено):** Менеджер отправляет фотографии/описание, которые сопровождаются названием, описанием преимуществ и ценой. В конце презентации обязательно задает вопрос, например: "Какой вариант понравился?".
    * **0 (Не применимо):** Диалог не дошел до этапа презентации товара.
    * **-1 (Не выполнено):** Менеджер отправил фотографии без описания, цены или сопровождающего вопроса.

5.  **Возражение клиента:**
    * **1 (Выполнено):** Клиент четко сформулировал возражение, сомнение, отказ или встречное условие (например, "Это дорого", "Я подумаю", "Мне не нравится цвет"). Присутствует фраза, подтверждающая наличие возражения.
    * **0 (Не применимо)::** Возражений со стороны клиента не было.
    * **-1 (Не выполнено):** Возражение клиента было, но менеджер его полностью проигнорировал, не дал клиенту высказаться или перебил его, не зафиксировав возражение.

6.  **Отработка возражения:** (Этот критерий актуален, только если было возражение)
    * **1 (Выполнено):** Менеджер активно и эффективно работает с возражением, применив формулу работы с возражениями (как минимум ДВЕ ПОПЫТКИ отработки, каждая включает: 1) Уточняющий вопрос, 2) Аргумент, 3) Закрывающий вопрос). По итогу диалога возражение снято или удалось продвинуться дальше по сделке.
    * **0 (Не применимо)::** Возражений не было или они были незначительными, не требующими специальной отработки.
    * **-1 (Не выполнено):** Штрафуется, только если есть пункт 1 в "Возражение клиента". Менеджер не отработал возражение, отработал его неэффективно (аргументы неубедительны, менеджер спорит с клиентом, не предлагает решения), усугубил возражение или попытка отработки не соответствовала формуле работы с возражениями.
    Если менеджер не отработал возражение должным образом, то нужно указать в SUMMARY в чем именно была ошибка.

7.  **Закрытие на оплату или предоплату:**
    * **1 (Выполнено):** Менеджер четко попытался вывести клиента на оплату или предоплату, используя призыв к действию, или отправил ссылку (выглядит так - pay.alfabank.ru/....
    * **0 (Не применимо):** Диалог не дошел до этапа оплаты или был закрыт до этого момента.
    * **-1 (Не выполнено):** Менеджер упустил возможность закрыть сделку на оплату, хотя все условия для этого были.

8.  **Проговорить договоренности с клиентом:**
    * **1 (Выполнено):** Менеджер проактивно подтверждает или уточняет КЛЮЧЕВЫЕ детали завершения сделки: точный адрес доставки (или условия самовывоза), желаемые/возможные сроки доставки/получения, контактные данные, способ связи. Обязательно использована фраза фиксации договоренностей с 2 вариантами на выбор (например, "Тогда договариваемся, что приедете к нам сегодня в 16.00...", "Отлично, придержу за вами растения, к концу дня буду ждать оплату...").
    * **0 (Не применимо):** Диалог завершился до этапа согласования деталей (например, клиент отказался или прервал диалог до этого этапа).
    * **-1 (Не выполнено):** Менеджер не уточнил или упустил важные детали, необходимые для организации доставки/получения заказа, или эти детали были согласованы неясно, или не зафиксировал договоренности.

**Формат ответа:**
Твой ответ должен содержать СТРОГО один блок JSON, за которым следует разделитель `---SUMMARY---`, а затем краткое резюме. В JSON-блоке не должно быть лишнего текста, только валидный JSON.

Пример JSON (СТРОГО используй двойные кавычки):
```json
{{
  "chat_category": "Заказ",
  "установление_контакта": 1,
  "квалификация": 1,
  "выявление_потребностей": 1,
  "презентация": 1,
  "возражение": 1,
  "отработка_возражения": 1,
  "проговорены_договоренности": 1,
  "закрытие_на_оплату": 1
}}
Инструкции для резюме (summary):
Резюме должно быть структурированным и содержать ключевые выводы для РОПа, отвечая на следующие вопросы. Используй HTML-тег <b> для выделения заголовков жирным шрифтом и разделяй каждый пункт пустой строкой, чтобы улучшить читаемость.

**Если какой-либо из следующих пунктов неприменим к диалогу (оценка 0 в JSON), не включай его в резюме.**

<b>Исход диалога:</b> Чем закончился разговор (заказ, отказ, перенос, запрос информации и т.д.).

<b>Квалификация:</b> Какие вопросы менеджер задал по квалификации (например, по бюджету, срокам) или почему не задал.

<b>Выявление потребностей:</b> Какие вопросы менеджер задал для выявления потребностей клиента или почему не задал.

<b>Презентация:</b> Как менеджер презентовал решение, что именно рассказал о продукте/компании.

<b>Возражения клиента:</b> Если были, пропиши текстом, что сказал клиент.

<b>Отработка возражений:</b> Если были возражения, что говорил менеджер при их отработке.

<b>Результат отработки возражений:</b> Клиент согласился или отказался после отработки возражения.

<b>Закрытие на оплату:</b> Попытался ли менеджер закрыть сделку на оплату, и если нет, то почему упущена возможность.

<b>Договоренности:</b> Какие договоренности менеджер установил с клиентом (например, о доставке, оплате).

<b>Следующий шаг:</b> Какие следующие шаги были обозначены менеджером или почему не были обозначены.

<b>Общие рекомендации:</b> Что можно улучшить в работе менеджера (конкретные рекомендации по развитию навыков или подходов).

Текст чата для анализа:
{}
"""
